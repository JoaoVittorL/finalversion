<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('style').getContent(); ?>
</head>

<body>
  <div class="container">
    <!-- form -->
    <form id="form">
      <!-- header -->
      <header class="backgroundImg">
        <img  class="img-fluid" src="https://i.imgur.com/PFsJWhA.png"/>
      </header>
      <!-- header -->







      <!-- Name and Setor -->
      <section>
        <div class="form-group">
          <label for="nameForAutoComplete">Name</label>
          <input class="inputStyle form-control" type="text"  name="name"  id="nameForAutoComplete" placeholder="Digite seu nome..."  required>
        </div>

        <div class="form-group">
          <label  for="setorForAutoComplete">Setor</label>
          <input  class="inputStyle form-control" type="text" name="setor" id="setorForAutoComplete" placeholder="Digite o seu setor..." required>
        </div>
      </section>
      <!-- Name and Setor -->
      <div class="form-group mb-4 box">
        <label class="mb-2">Example select element</label>
        <select class="form-control mb-2" id="input2">
        <option disabled selected>Choose</option>
        <?!= options ?>
      </select>
      </div>
      <!-- Autocomplete  categorias-->
      <section>
        <div>
          <label>Category:</label>
          <select class="form-select form-select-lg mb-1" id="color" name="color" onchange="getCategoria(this.value)" aria-label=".form-select-lg example">
          <option value="" disabled selected>Escolha</option>
          <? for (var i = 0; i < colors.length; i++) { ?>
            <option value="<?= colors[i] ?>"><?= colors[i] ?></option>
          <? } ?>
        </select>
        </div>
        <div>
          <label>Subcategory:</label>
          <select class="form-select form-select-lg mb-1" name="fruit" id="fruit" aria-label=".form-select-lg example">
          <option value="" disabled selected>Escolha</option>
        </select>
        </div>
      </section>
      <!-- Autocomplete  categorias-->

      <div class="mb-1">
        <label  for="textarea" class="form-label">Descrição</label>
        <textarea class="form-control" id="textarea" rows="6" placeholder="Descreva o seu chamado..." required></textarea>
      </div>



      <div class="fileUpload btn btn-primary">
        <span>Upload</span>
        <input id="file"  type="file" type="file" class="upload" />
      </div>

      <button type="submit" id="button" value="Enviar formulário">Enviar Formulário</button>

    </form>
    <!-- form -->
    <!-- modal -->
    <div style="display:none;" id="modal">
      <p style="text-align:center; font-size: 20px;">As informações estão corretas ?</p>
      <div class="modalButton">
        <button id="btnYes" onclick="sendValues()">Sim</button>
        <button id="btnNo" onclick="closeModal()">Não</button>
      </div>
    </div>
    <!-- modal -->
    <!-- Endmodal -->
    <div style="display:none;" id="modalEnd">
      <p style=" display:block ;text-align:center; font-size: 20px;">Formulário enviado com sucesso!!!</p>
      <div>
        <button id="EndButton">OK</button>
      </div>
    </div>
    <!-- Endmodal -->
  </div>
</body>
<script>
  $(document).ready(function() {
      getNameForAutoComplete();
      getSetorForAutoComplete()
    });

    function getSetorForAutoComplete() {
      google.script.run.withSuccessHandler(function(ar) {
        statesArray = [];
        ar.forEach(function(item, index) {
          statesArray.push(item[0]);
        });

        $("#setorForAutoComplete").autocomplete({
          source: statesArray
        });
      }).getSetorForAutoComplete();
    }

//AUTO COMPLETE JQUERY
  const fileUploader = document.getElementById("file"); //ARQUIVO PARA ENVIO
  const button = document.querySelector("#button") 
  const modal = document.querySelector("#modal")
  const form = document.querySelector("#form")
  button.addEventListener('click', showOptionsForUsers)

  const endButton = document.querySelector('#EndButton').addEventListener('click', initialOfEnd)
  const endModal = document.querySelector('#modalEnd')  
  
  function initialOfEnd(){
     endModal.style.display = 'none'
     showForm()
  }

function showOptionsForUsers(e){
    e.preventDefault()
    showModal()
    hiddenForm()
  }

//Mostrar o sim e não 
function showModal(){
    modal.style.display = 'block'
}
//Esconde o forms
function hiddenForm(){
   form.style.display = 'none'
} 

//Se escolher o Não no showModal ele volta  mostra o forms  esconde o modal
function closeModal(){
   modal.style.display = 'none'
   showForm()
}

//Mostra o forms quando escolhe o não
function showForm(){
   form.style.display = 'block'
} 


function showEndModal(){
  modal.style.display = 'none'
  endModal.style.display = 'block'
}


let arr = [];
function getNameForAutoComplete() {
  google.script.run.withSuccessHandler(function(ar) {
    arr = ar.flat().filter((element) => {
      return element !== "";
    });
    statesArray = [];
    arr.forEach(function(item, index) {
      statesArray.push(item);
    });
    $("#nameForAutoComplete").autocomplete({
      source: statesArray
    });
  }).getNameForAutoComplete();
} 


  
function sendValues(){
    let inputName = document.querySelector('#nameForAutoComplete').value
    let inputSetor = document.querySelector('#setorForAutoComplete').value
    let textarea = document.querySelector('#textarea').value
    let fileUploader = document.getElementById("file"); //ARQUIVO PARA ENVIO
    let color = document.getElementById('color').value
    let fruit = document.getElementById('fruit').value
    let msg = document.getElementById('#message')

  
    console.log(arr)

    if (!arr.includes(inputName)) {
    alert(`O (${inputName}) informado não está na lista de nomes disponíveis.`);
    closeModal()
    return;
  }


    if (fileUploader.files.length > 0) {
     
    var file = fileUploader.files[0];
    var reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function() {
      var rawLog = reader.result.split(',')[1];
      google.script.run
        .withSuccessHandler(function(a) {
          showEndModal()
        })
        .uploadFilesToGoogleDrive(rawLog, file.name, file.type, inputName, inputSetor, textarea, fruit, color);
         clear();
      };
    } else {
    google.script.run.withSuccessHandler(function(a) {
        showEndModal()
      }).uploadFilesToGoogleDriveNothingFile(inputName, inputSetor,textarea, fruit, color);
      clear();
      }
    }

  
  function clear(){
     document.getElementById("nameForAutoComplete").value = "";
     document.getElementById("setorForAutoComplete").value = "";
     document.getElementById("textarea").value = "";
     document.getElementById("color").value = "";
     document.getElementById("fruit").value = "";
     document.getElementById("fileUploader").value = "";
   }

   //Pegar categorias e aplicar no select option

    function getCategoria(color) 
    {
    
    google.script.run.withSuccessHandler(function(ar) 
    {

    console.log(ar);
    
    fruit.length = 0;
    
    let option = document.createElement("option");
    option.value = "";
    option.text = "";
    fruit.appendChild(option);
    
    ar.forEach(function(item, index) 
    {    
      let option = document.createElement("option");
      option.value = item;
      option.text = item;
      fruit.appendChild(option);    
    });
    
    }).getCategorias(color);
    
    };

</script>

</html>